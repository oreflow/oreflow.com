/*! Oreflow.com 2014-07-30 */
angular.module("oreflow",["ng","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{controller:"HomeCtrl",templateUrl:"/app/Home/home.html"}).otherwise({redirectTo:"/"})}]),angular.module("oreflow").run(["$templateCache",function(a){"use strict";a.put("app/Home/home.html",'\r\n<!-- ng-style="{left: windowSize.innerWidth / 2 - Math.min(windowSize.innerWidth,windowSize.innerHeight)/2}" -->\r\n<canvas id="webgl-canvas"\r\n\r\n        style="position: absolute; top:0px;" width="500" height="500" ></canvas>')}]),angular.module("oreflow").controller("HomeCtrl",["$scope","$window","webGLService",function(a,b,c){a.windowSize={innerHeight:b.innerHeight,innerWidth:b.innerWidth},a.Math=Math;var d=document.getElementById("webgl-canvas");d.height=b.innerHeight,d.width=b.innerWidth-10,c.webGLStart(d);angular.element(b).bind("resize",function(){a.windowSize.innerHeight=b.innerHeight,a.windowSize.innerWidth=b.innerWidth,c.setDimensions(b.innerHeight,b.innerWidth),d.height=b.innerHeight,d.width=b.innerWidth-10;try{a.$digest()}catch(e){}})}]),angular.module("oreflow").service("boatService",["commonService","objService",function(a,b){var c,d,e=-90,f={},g=4,h=0,i=2,j=0,k=0,l=0,m=0,n=function(){var g=(new Date).getTime(),i=g-m;if(i>2e3)return void(m=(new Date).getTime());if(0!=m){if(c||(c=b.getModel("express")),d||(d=b.getModel("boom")),f.port||(f.port=b.getModel("curved_port_sail")),f.starboard||(f.starboard=b.getModel("curved_starboard_sail")),f.plain||(f.plain=b.getModel("plain_sail")),!c||!d)return void console.log("returning since model was missing");if(f.port&&f.starboard&&f.plain)switch(f.port.draw=!1,f.starboard.draw=!1,f.plain.draw=!1,!0){case 0>h:f.port.draw=!0;break;case 0==h:f.plain.draw=!0;break;case h>0:f.starboard.draw=!0}var n=c.rotation.y,q=(n-e)%360;switch(!0){case 45>q:h>0?(o(90),p(5)):p(0);break;case 90>q:o(45),p(10);break;case 135>q:o(20),p(30);break;case 180>q:o(20),p(20);break;case 225>q:o(-20),p(-20);break;case 270>q:o(-45),p(-30);break;case 315>q:o(-90),p(-10);break;case 360>q:0>h?(o(-90),p(-5)):p(0)}var r=j-k;k+=r*i/1e3;var s=h-l;l+=s*i/1e3,c.rotation.x=k*Math.cos(a.angles.degToRad(n)),c.rotation.z=-k*Math.sin(a.angles.degToRad(n)),d.rotation.x=c.rotation.x,d.rotation.z=c.rotation.z,d.rotation.y=c.rotation.y+l,f.port&&(f.port.rotation.x=d.rotation.x,f.port.rotation.z=d.rotation.z,f.port.rotation.y=d.rotation.y,f.port.translation.x=c.translation.x,f.port.translation.z=c.translation.z,f.port.translation.y=c.translation.y),f.starboard&&(f.starboard.rotation.x=d.rotation.x,f.starboard.rotation.z=d.rotation.z,f.starboard.rotation.y=d.rotation.y,f.starboard.translation.x=c.translation.x,f.starboard.translation.z=c.translation.z,f.starboard.translation.y=c.translation.y),f.plain&&(f.plain.rotation.x=d.rotation.x,f.plain.rotation.z=d.rotation.z,f.plain.rotation.y=d.rotation.y,f.plain.translation.x=c.translation.x,f.plain.translation.z=c.translation.z,f.plain.translation.y=c.translation.y)}m=g},o=function(b){Math.cos(a.angles.degToRad(b))<0||(h=b)},p=function(b){Math.cos(a.angles.degToRad(b))<0||(j=b)},q=function(){return c||(c=b.getModel("express")),d||(d=b.getModel("boom")),c&&d?{front:{x:d.translation.x+Math.sin(a.angles.degToRad(h))*g/2,z:d.translation.z+Math.cos(a.angles.degToRad(h))*g/2,y:d.translation.y+Math.sin(a.angles.degToRad(i))*g/2},back:{x:d.translation.x-Math.sin(a.angles.degToRad(h))*g/2,z:d.translation.z-Math.cos(a.angles.degToRad(h))*g/2,y:d.translation.y-Math.sin(a.angles.degToRad(i))*g/2}}:void console.log("returning since model was missing")};return{updatePosition:n,setBoomAngle:o,getCoordinates:q,setBoatHeel:p}}]),angular.module("oreflow").service("commonService",[function(){var a={degToRad:function(a){return a*Math.PI/180},radToDeg:function(a){return 180*a/Math.PI}};return{angles:a}}]),angular.module("oreflow").service("objService",["$q",function(){var a={},b={},c=function(c,e,f){if("model"===e.type){var g,h={vertices:[],verticeObjects:[],normals:[],faces:[],objects:{}};lines=c.split("\n");for(var i=0;i<lines.length;i++){var j=lines[i];if("o"===j.substr(0,1))g=j.substr(2),h.objects[g]={},h.objects[g].vertices=[],h.objects[g].normals=[];else{if(g&&"vt"===j.substr(0,2))throw"Not implemented Texture coordinates";if(g&&"vn"===j.substr(0,2)){var k=j.split(" ");h.normals.push([parseFloat(k[1]),parseFloat(k[2]),parseFloat(k[3])])}else{if(g&&"vp"===j.substr(0,2))throw"Not implemented parameter space vertices";if(g&&"v"===j.substr(0,1)){var k=j.split(" ");switch(k.length){case 4:h.vertices.push([parseFloat(k[1]),parseFloat(k[2]),parseFloat(k[3])]),h.verticeObjects.push(h.objects[g]);break;case 5:throw"Not implemented vertices with [w]"}}else if(g&&"f"===j.substr(0,1)){var k=j.split(" "),l=function(a){var b=a.split("/");return{face:parseFloat(b[0])-1,textureCoordinate:parseFloat(b[1]),normal:parseFloat(b[2])-1}};switch(k.length){case 4:h.faces.push({face:[l(k[1]).face,l(k[2]).face,l(k[3]).face],textureCoordinate:[l(k[1]).textureCoordinate,l(k[2]).textureCoordinate,l(k[3]).textureCoordinate],normal:[l(k[1]).normal,l(k[2]).normal,l(k[3]).normal]});break;case 5:h.faces.push({face:[l(k[1]).face,l(k[2]).face,l(k[3]).face],textureCoordinate:[l(k[1]).textureCoordinate,l(k[2]).textureCoordinate,l(k[3]).textureCoordinate],normal:[l(k[1]).normal,l(k[2]).normal,l(k[3]).normal]}),h.faces.push({face:[l(k[1]).face,l(k[3]).face,l(k[4]).face],textureCoordinate:[l(k[1]).textureCoordinate,l(k[3]).textureCoordinate,l(k[4]).textureCoordinate],normal:[l(k[1]).normal,l(k[3]).normal,l(k[4]).normal]});break;default:throw console.log(k),"Not implemented faces with other than 3 or 4 vertices"}}else g&&"usemtl"===j.substr(0,6)?h.objects[g].material=j.substr(7):"mtllib"===j.substr(0,6)&&(h.materials=d(j.substr(7),f))}}}h.rotation={x:0,y:0,z:0},h.translation={x:0,y:0,z:0},h.scale={x:1,y:1,z:1},a[e.name]=h}else if("path"===e.type){var m,n={vertices:[]},o=0;lines=c.split("\n");for(var i=0;i<lines.length;i++){var j=lines[i];if("o"===j.substr(0,1)){if(m)throw"Not allowing more than one path per path file";m=j.substr(2)}else if(m&&"v"===j.substr(0,1)){var k=j.split(" ");switch(k.length){case 4:n.vertices[o]={x:parseFloat(k[1]),y:parseFloat(k[2]),z:parseFloat(k[3])},o++;break;case 5:throw"Not implemented vertices with [w]"}}else if(m&&"l"===j.substr(0,1));else{if(m&&"vt"===j.substr(0,2))throw"Textures not allowed in path files";if(m&&"vn"===j.substr(0,2))throw"Normals not allowed in path files";if(m&&"vp"===j.substr(0,2))throw"parameter space vertices not allowed in path files";if(m&&"f"===j.substr(0,1))throw"faces not allowed in path files";if(m&&"usemtl"===j.substr(0,6))throw"materials not allowed in path files";"mtllib"===j.substr(0,6)}}b[e.name]=n}},d=function(a,b){var c=$.get("models/"+a);b.push(c);var d={};return $.when(c).done(function(){for(var a,b,e=c.responseText.split("\n"),f=0;f<e.length;f++)if(b=e[f],"newmtl"===b.substr(0,6))a=b.substr(7),d[a]={};else if(a&&"Ka"==b.substr(0,2)){var g=b.split(" ");d[a].ambient=[parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])]}else if(a&&"Kd"==b.substr(0,2)){var g=b.split(" ");d[a].diffuse=[parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])]}else if(a&&"Ks"==b.substr(0,2)){var g=b.split(" ");d[a].specular=[parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])]}else if(a&&("d"==b.substr(0,1)||"Tr"==b.substr(0,2))){var g=b.split(" ");d[a].opacity=parseFloat(g[1])}}),d},e=function(){return a},f=function(b){return a[b]},g=function(){return b},h=function(a){return b[a]};return{loadObj:c,getMaterials:d,getModels:e,getModel:f,getPaths:g,getPath:h}}]),angular.module("oreflow").service("pathService",["objService","commonService",function(a,b){var c,d,e={boatPath:{running:!0,repeat:!0,currentIndex:0,speed:1.5,model:"express",translation:{x:0,y:-6,z:0},rotation:{x:0,y:90,z:0},initialized:!1,rotationAligned:!0}},f=0,g=function(){var g=(new Date).getTime();if(0!=f){var i=g-f;if(i>2e3)return void(f=(new Date).getTime());if(c&&d||(c=a.getModels(),d=a.getPaths()),c&&d)for(var j=Object.keys(e),k=0;k<j.length;k++){var l=e[j[k]];if(l.running&&c[l.model]&&d[j[k]]){l.initialized||(c[l.model].translation.x=d[j[k]].vertices[0].x+l.translation.x,c[l.model].translation.y=d[j[k]].vertices[0].y+l.translation.y,c[l.model].translation.z=d[j[k]].vertices[0].z+l.translation.z,l.initialized=!0);var m=l.speed*i/1e3,n=JSON.parse(JSON.stringify(c[l.model].translation));l.currentIndex>=d[j[k]].vertices.length-1&&(l.repeat?l.currentIndex=0:(l.running=!1,l.currentIndex=d[j[k]].vertices.length-1));var o=h(c[l.model].translation,!1,d[j[k]].vertices[l.currentIndex+1],l.translation);if(o>=m){var p=d[j[k]].vertices[l.currentIndex+1].x+l.translation.x-c[l.model].translation.x,q=d[j[k]].vertices[l.currentIndex+1].y+l.translation.y-c[l.model].translation.y,r=d[j[k]].vertices[l.currentIndex+1].z+l.translation.z-c[l.model].translation.z;c[l.model].translation.x+=p/o*m,c[l.model].translation.y+=q/o*m,c[l.model].translation.z+=r/o*m}else l.currentIndex++,c[l.model].translation.x=d[j[k]].vertices[l.currentIndex].x+l.translation.x,c[l.model].translation.y=d[j[k]].vertices[l.currentIndex].y+l.translation.y,c[l.model].translation.z=d[j[k]].vertices[l.currentIndex].z+l.translation.z;if(l.rotationAligned){var s=JSON.parse(JSON.stringify(c[l.model].translation)),p=s.x-n.x,q=s.y-n.y,r=s.z-n.z,t=b.angles.radToDeg(Math.atan(r/q))+l.rotation.x;q>0&&(t+=180);var u=b.angles.radToDeg(Math.atan(p/r))+l.rotation.y;r>0&&(u+=180);var v=b.angles.radToDeg(Math.atan(q/p))+l.rotation.z;p>0&&(v+=180);var w=t-c[l.model].rotation.x;(w>1||-1>w)&&(c[l.model].rotation.x+=Math.abs(w)>180?w*i/1e3/36:2*w*i/1e3);var x=u-c[l.model].rotation.y;(x>1||-1>x)&&(Math.abs(x)>180?c[l.model].rotation.y-=x*i/1e3/36:c[l.model].rotation.y+=2*x*i/1e3);var y=v-c[l.model].rotation.z;(y>1||-1>y)&&(c[l.model].rotation.z+=Math.abs(y)>180?y*i/1e3/36:2*y*i/1e3),c[l.model].rotation.x=c[l.model].rotation.x%360,c[l.model].rotation.y=c[l.model].rotation.y%360,c[l.model].rotation.z=c[l.model].rotation.z%360}}}for(var j=Object.keys(e),k=0;k<j.length;k++){var l=e[j[k]];l.keyFrames&&console.log("updating keyFrames")}}f=g},h=function(a,b,c,d){return Math.sqrt(b&&d?Math.pow(c.x+d.x-(a.x+b.x),2)+Math.pow(c.y+d.y-(a.y+b.y),2)+Math.pow(c.z+d.z-(a.z+b.z),2):b?Math.pow(c.x-(a.x+b.x),2)+Math.pow(c.y-(a.y+b.y),2)+Math.pow(c.z-(a.z+b.z),2):d?Math.pow(c.x+d.x-a.x,2)+Math.pow(c.y+d.y-a.y,2)+Math.pow(c.z+d.z-a.z,2):Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2)+Math.pow(c.z-a.z,2))};return{updatePaths:g}}]),angular.module("oreflow").service("webGLService",["objService","commonService","boatService","pathService",function(a,b,c,d){function e(a){try{o=a.getContext("webgl")||a.getContext("experimental-webgl"),o.viewportWidth=a.width,o.viewportHeight=a.height}catch(b){}o||alert("Could not initialise WebGL, sorry :-(")}function f(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert(a.getShaderInfoLog(f)),null)}function g(){var a=f(o,"shader-fs"),b=f(o,"shader-vs");p=o.createProgram(),o.attachShader(p,b),o.attachShader(p,a),o.linkProgram(p),o.getProgramParameter(p,o.LINK_STATUS)||alert("Could not initialise shaders"),o.useProgram(p),p.vertexPositionAttribute=o.getAttribLocation(p,"aVertexPosition"),o.enableVertexAttribArray(p.vertexPositionAttribute),p.vertexNormalAttribute=o.getAttribLocation(p,"aVertexNormal"),o.enableVertexAttribArray(p.vertexNormalAttribute),p.vertexColorAttribute=o.getAttribLocation(p,"aVertexColor"),o.enableVertexAttribArray(p.vertexColorAttribute),p.pMatrixUniform=o.getUniformLocation(p,"uPMatrix"),p.mvMatrixUniform=o.getUniformLocation(p,"uMVMatrix"),p.nMatrixUniform=o.getUniformLocation(p,"uNMatrix"),p.samplerUniform=o.getUniformLocation(p,"uSampler"),p.useLightingUniform=o.getUniformLocation(p,"uUseLighting"),p.ambientColorUniform=o.getUniformLocation(p,"uAmbientColor"),p.lightingDirectionUniform=o.getUniformLocation(p,"uLightingDirection"),p.directionalColorUniform=o.getUniformLocation(p,"uDirectionalColor")}function h(){o.uniformMatrix4fv(p.pMatrixUniform,!1,s),o.uniformMatrix4fv(p.mvMatrixUniform,!1,q);var a=mat3.create();mat4.toInverseMat3(q,a),mat3.transpose(a),o.uniformMatrix3fv(p.nMatrixUniform,!1,a)}function i(){var a=mat4.create();mat4.set(q,a),r.push(a)}function j(){if(0==r.length)throw"Invalid popMatrix!";q=r.pop()}function k(){for(var a=Object.keys(t),b=0;b<a.length;b++){for(var c=t[a[b]],d=[],e=[],f=[],g=[],h=0;h<c.faces.length;h++){d[9*h+0]=c.vertices[c.faces[h].face[0]][0],d[9*h+1]=c.vertices[c.faces[h].face[0]][1],d[9*h+2]=c.vertices[c.faces[h].face[0]][2],d[9*h+3]=c.vertices[c.faces[h].face[1]][0],d[9*h+4]=c.vertices[c.faces[h].face[1]][1],d[9*h+5]=c.vertices[c.faces[h].face[1]][2],d[9*h+6]=c.vertices[c.faces[h].face[2]][0],d[9*h+7]=c.vertices[c.faces[h].face[2]][1],d[9*h+8]=c.vertices[c.faces[h].face[2]][2];var i=c.materials[c.verticeObjects[c.faces[h].face[0]].material];g[12*h+0]=i.diffuse[0],g[12*h+1]=i.diffuse[1],g[12*h+2]=i.diffuse[2],g[12*h+3]=i.opacity,g[12*h+4]=i.diffuse[0],g[12*h+5]=i.diffuse[1],g[12*h+6]=i.diffuse[2],g[12*h+7]=i.opacity,g[12*h+8]=i.diffuse[0],g[12*h+9]=i.diffuse[1],g[12*h+10]=i.diffuse[2],g[12*h+11]=i.opacity,f[9*h+0]=c.normals[c.faces[h].normal[0]][0],f[9*h+1]=c.normals[c.faces[h].normal[0]][1],f[9*h+2]=c.normals[c.faces[h].normal[0]][2],f[9*h+3]=c.normals[c.faces[h].normal[1]][0],f[9*h+4]=c.normals[c.faces[h].normal[1]][1],f[9*h+5]=c.normals[c.faces[h].normal[1]][2],f[9*h+6]=c.normals[c.faces[h].normal[2]][0],f[9*h+7]=c.normals[c.faces[h].normal[2]][1],f[9*h+8]=c.normals[c.faces[h].normal[2]][2],e[3*h+0]=c.faces[h].face[0],e[3*h+1]=c.faces[h].face[1],e[3*h+2]=c.faces[h].face[2]}c.vertexPositionBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,c.vertexPositionBuffer),o.bufferData(o.ARRAY_BUFFER,new Float32Array(d),o.STATIC_DRAW),c.vertexPositionBuffer.itemSize=3,c.vertexPositionBuffer.numItems=d.length/3,c.colorBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,c.colorBuffer),o.bufferData(o.ARRAY_BUFFER,new Float32Array(g),o.STATIC_DRAW),c.colorBuffer.itemSize=4,c.colorBuffer.numItems=g.length/4,c.vertexNormalIndexBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,c.vertexNormalIndexBuffer),o.bufferData(o.ARRAY_BUFFER,new Float32Array(f),o.STATIC_DRAW),c.vertexNormalIndexBuffer.itemSize=3,c.vertexNormalIndexBuffer.numItems=f.length/3,c.vertexIndexBuffer=o.createBuffer(),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,c.vertexIndexBuffer),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),o.STATIC_DRAW),c.vertexIndexBuffer.itemSize=1,c.vertexIndexBuffer.numItems=e.length}}function l(){d.updatePaths(),c.updatePosition(),o.viewport(0,0,o.viewportWidth,o.viewportHeight),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),mat4.perspective(45,o.viewportWidth/o.viewportHeight,.1,100,s),mat4.identity(q),mat4.translate(q,[v.translation.x,v.translation.y,v.translation.z]);for(var a=Object.keys(t),e=0;e<a.length;e++){var f=t[a[e]];if(f.draw!==!1){i(),mat4.translate(q,[f.translation.x,f.translation.y,f.translation.z]),mat4.rotate(q,b.angles.degToRad(f.rotation.x),[1,0,0]),mat4.rotate(q,b.angles.degToRad(f.rotation.z),[0,0,1]),mat4.rotate(q,b.angles.degToRad(f.rotation.y),[0,1,0]),q[0]=q[0]*f.scale.x,q[5]=q[5]*f.scale.y,q[10]=q[10]*f.scale.z,o.bindBuffer(o.ARRAY_BUFFER,f.vertexPositionBuffer),o.vertexAttribPointer(p.vertexPositionAttribute,f.vertexPositionBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,f.vertexNormalIndexBuffer),o.vertexAttribPointer(p.vertexNormalAttribute,f.vertexNormalIndexBuffer.itemSize,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,f.colorBuffer),o.vertexAttribPointer(p.vertexColorAttribute,f.colorBuffer.itemSize,o.FLOAT,!1,0,0),o.uniform3f(p.ambientColorUniform,v.ambient.r,v.ambient.g,v.ambient.b);var g=vec3.create();vec3.normalize(v.lightingDirection,g),vec3.scale(g,-1),o.uniform3fv(p.lightingDirectionUniform,g),o.uniform3f(p.directionalColorUniform,.8,.8,.8),h(),o.drawArrays(o.TRIANGLES,0,f.vertexPositionBuffer.numItems),j()}}}function m(){var a=(new Date).getTime();if(0!=w){var b=a-w;t.water.rotation.y+=1*b/1e3,t.water.rotation.y=t.water.rotation.y%360}w=a}function n(){requestAnimFrame(n),l(),m()}var o,p,q=mat4.create(),r=[],s=mat4.create(),t={},u=[],v={},w=0,x=function(b){var c=[{name:"house",url:"models/house.obj",type:"model"},{name:"island",url:"models/island.obj",type:"model"},{name:"express",url:"models/express.obj",type:"model"},{name:"boom",url:"models/boom.obj",type:"model"},{name:"plain_sail",url:"models/plain_sail.obj",type:"model"},{name:"curved_starboard_sail",url:"models/curved_starboard_sail.obj",type:"model"},{name:"curved_port_sail",url:"models/curved_port_sail.obj",type:"model"},{name:"water",url:"models/water.obj",type:"model"},{name:"boatPath",url:"paths/boatPath.obj",type:"path"},{name:"airtext_clouds_test",url:"models/airtext_clouds_test.obj",type:"model"},{name:"airPath",url:"paths/airPath2.obj",type:"path"}];t=a.getModels();for(var d=[],f=0;f<c.length;f++)d.push($.get(c[f].url));var h=$.when.apply($,d);h.done(function(){for(var f=0;f<c.length;f++)a.loadObj(d[f].responseText,c[f],u);v.translation={x:0,y:-3,z:-55},v.lightingDirection=[1,-1,1],v.ambient={r:.4,g:.4,b:.4},t.house.translation.y+=-7,t.island.translation.y+=-8,t.island.rotation.y+=180,t.express.translation.y+=-5.8,t.express.translation.x+=10,t.express.translation.z+=10,t.water.translation.y+=-8,t.water.translation.x+=2,t.airtext_clouds_test.translation.y=10,t.airtext_clouds_test.scale.x=.6,t.airtext_clouds_test.scale.y=.6,t.airtext_clouds_test.scale.z=.6,t.plain_sail.draw=!1,t.boom.draw=!1;var h=$.when.apply($,u);h.done(function(){e(b),g(),k(),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),n()})})},y=function(a,b){o.viewportHeight=a,o.viewportWidth=b};return{webGLStart:x,setDimensions:y}}]);